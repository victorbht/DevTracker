<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>DevTracker Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><defs><linearGradient id=%22g%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22><stop offset=%220%25%22 stop-color=%22%231abc9c%22/><stop offset=%22100%25%22 stop-color=%22%233498db%22/></linearGradient></defs><path d=%22M50 5 L95 27.5 L95 72.5 L50 95 L5 72.5 L5 27.5 Z%22 fill=%22url(%23g)%22/><text x=%2250%22 y=%2265%22 font-family=%22monospace%22 font-weight=%22bold%22 font-size=%2250%22 fill=%22white%22 text-anchor=%22middle%22>&gt;_</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js"></script>

    <style>
        :root {
            --bg-01: #0b111b;
            --bg-02: #0f1624;
            --hud-bg: #151f32;
            --card: rgba(255,255,255,0.04);
            --card-border: rgba(255,255,255,0.08);
            --accent: #22e3a1;
            --accent-2: #4db5ff;
            --accent-pink: #bc13fe;
            --text: #f7fbff;
            --muted: #e0e8f5;
            --warning: #f1c40f;
            --danger: #ff6b6b;
            --sidebar-width: 260px;
        }
        body {
            background: radial-gradient(circle at 20% 20%, rgba(34,227,161,0.07), transparent 25%), radial-gradient(circle at 80% 0%, rgba(77,181,255,0.12), transparent 25%), linear-gradient(135deg, #0a0f18 0%, #0f1726 100%);
            color: var(--text);
            font-family: 'Space Grotesk', 'Segoe UI', sans-serif;
            padding-top: 88px;
            overflow-x: hidden;
        }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top:0; left:0; background: var(--hud-bg); border-right: 1px solid var(--card-border); display: flex; flex-direction: column; z-index: 1040; }
        .sidebar-brand { padding: 1.5rem; display: flex; align-items: center; border-bottom:1px solid var(--card-border); }
        .sidebar .nav-link { color: var(--muted); padding: 0.9rem 1.4rem; font-weight: 700; border-left:3px solid transparent; }
        .sidebar .nav-link i { width: 24px; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.04); border-left-color: var(--accent); }
        .nav-link.rpg-link:hover { border-left-color: var(--accent-pink); color: var(--accent-pink); }
        .main-content { margin-left: var(--sidebar-width); padding: 1.5rem; }
        .navbar-devtracker { z-index: 1050; }
        .navbar-mobile { display:none; }
        @media (max-width: 992px){
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; padding-top: 90px; }
            .navbar-mobile { display:flex; }
        }
        a { color: inherit; }
        .navbar-devtracker { background: rgba(12,18,30,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--card-border); }
        .card, .modal-content, .btn, .form-control, .form-select, .badge { border-radius: 14px !important; }
        .shadow-soft { box-shadow: 0 15px 40px rgba(0,0,0,0.25) !important; }
        .hero-card { background: linear-gradient(135deg, rgba(34,227,161,0.08), rgba(77,181,255,0.1)), var(--bg-02); border: 1px solid var(--card-border); }
        .text-muted-2 { color: var(--muted) !important; }
        .text-accent { color: var(--accent); }
        .chip { background: rgba(255,255,255,0.07); border: 1px solid var(--card-border); border-radius: 999px; padding: 6px 12px; }
        .badge-conquista { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .badge-conquista:hover { transform: translateY(-4px) scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .filter-pill { border-radius: 999px !important; border: 1px solid var(--card-border); color: var(--muted); }
        .filter-pill.active { background: var(--accent); color: #0b111b; border-color: transparent; font-weight: 700; }
        .table thead th { position: sticky; top: 0; background: var(--bg-02); z-index: 2; }
        .table { color: var(--text); font-weight: 600; }
        .table, .table td, .table th { background-color: transparent !important; border-color: rgba(255,255,255,0.08) !important; }
        .table-hover tbody tr:hover { background: rgba(255,255,255,0.08); }
        .table thead { color: #ffffff; text-transform: uppercase; font-size: 0.86rem; letter-spacing: 1.5px; font-weight: 900; text-shadow: 0 2px 3px rgba(0,0,0,0.6); background: rgba(255,255,255,0.04); }
        .table tbody td { color: #f7fbff; }
        .table tbody tr { cursor: pointer; }
        .pill-status { border-radius: 999px; padding: 6px 10px; font-weight: 600; }
        .floating-button { position: fixed; bottom: 28px; right: 28px; z-index: 1050; padding: 14px 22px; border-radius: 999px !important; font-weight: 700; box-shadow: 0 12px 30px rgba(34,227,161,0.25); background: linear-gradient(135deg, var(--accent), var(--accent-2)); border: none; color: #0b111b; }
        .floating-button:hover { transform: translateY(-2px); }
        .card-slim { background: var(--card); border: 1px solid var(--card-border); }
        .action-btn { border: 1px solid var(--card-border); background: rgba(255,255,255,0.05); color: var(--text); }
        .action-btn:hover { border-color: var(--accent); color: var(--accent); }
        .toast-container { position: fixed; top: 90px; right: 24px; z-index: 2000; }
        .avatar-box { width: 90px; height: 90px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1b2334, #101725); border: 1px solid var(--card-border); position: relative; color: var(--text); font-weight: 700; font-size: 1.2rem; letter-spacing: 1px; }
        .level-badge { position: absolute; bottom: -8px; right: -8px; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 8px; }
        .calendar-cell { padding: 10px; border-radius: 12px; border: 1px solid var(--card-border); background: rgba(255,255,255,0.02); min-height: 72px; display: flex; flex-direction: column; justify-content: center; transition: background 0.2s ease, border-color 0.2s ease; }
        .calendar-cell.active { border-color: var(--accent); background: rgba(34,227,161,0.08); }
        .calendar-day { font-weight: 700; color: var(--text); }
        .calendar-time { color: var(--muted); font-size: 0.85rem; }
        .calendar-today { outline: 2px solid var(--accent); outline-offset: 2px; }
        .calendar-selected { box-shadow: 0 0 0 2px var(--accent-2); }
        .sessions-panel { background: rgba(255,255,255,0.04); border: 1px solid var(--card-border); border-radius: 12px; padding: 12px; }
        .method-chip { background: linear-gradient(135deg, #6dd5ed 0%, #2193b0 100%); color: #0b111b; border: none; font-weight: 700; }
        .sortable { cursor: pointer; }
        .sortable::after { content: " ⇅"; font-size: 0.75rem; opacity: 0.6; }
        #dNote { white-space: pre-wrap; }
        #dNote p { margin-bottom: 0.35rem; color: var(--text); }
        #dNote code { background: rgba(255,255,255,0.12); padding: 3px 7px; border-radius: 6px; color: var(--text); font-family: 'Source Code Pro', monospace; }
        #dNote pre { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: var(--text); font-family: 'Source Code Pro', monospace; white-space: pre-wrap; }
        .list-group-item { color: var(--text); }
        .modal-backdrop.show { opacity: 0.9; }
        @keyframes pop { 0%{transform: scale(0.8); opacity:0;} 100%{transform: scale(1); opacity:1;} }
        @keyframes confettiFall { 0% { transform: translateY(-20vh) rotate(0deg);} 100% { transform: translateY(60vh) rotate(360deg);} }
        @media (max-width: 768px) {
            body { padding-top: 76px; }
            .table-responsive { border: 0; }
            .table { font-size: 0.95rem; }
            .table thead { display: none; }
            .table tbody tr { display: block; margin-bottom: 12px; background: rgba(255,255,255,0.06); border-radius: 12px; padding: 12px; }
            .table tbody td { display: flex; justify-content: space-between; align-items: center; border-top: 0 !important; padding: 6px 0; }
            .table tbody td::before { content: attr(data-label); font-weight: 700; color: var(--muted); margin-right: 8px; }
            .hero-card .card-body { padding: 1.2rem; }
            .hero-card .d-flex { gap: 10px; }
.chip { padding: 6px 10px; }
        }
    </style>
</head>
<body>
    {% load widget_tweaks %} {% load core_extras %}

    <nav class="sidebar d-none d-lg-flex">
        <div class="sidebar-brand">
            <svg width="42" height="42" viewBox="0 0 100 100" class="me-2" xmlns="http://www.w3.org/2000/svg">
                <defs><linearGradient id="bG" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#1abc9c"/><stop offset="100%" style="stop-color:#3498db"/></linearGradient></defs>
                <path d="M50 5 L95 27.5 L95 72.5 L50 95 L5 72.5 L5 27.5 Z" fill="url(#bG)" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>
                <text x="50" y="62" font-family="monospace" font-weight="bold" font-size="45" fill="white" text-anchor="middle">&gt;_</text>
            </svg>
            <div class="d-flex flex-column" style="line-height:1;">
                <span class="text-white fw-bold fs-5">Dev<span style="color: var(--accent);">Tracker</span></span>
                <span class="text-muted-2" style="font-size:0.65rem; letter-spacing:1px;">RPG SYSTEM</span>
            </div>
        </div>
        <div class="flex-grow-1 py-3 overflow-auto">
            <small class="text-muted-2 px-4 text-uppercase fw-bold" style="font-size:0.7rem;">Principal</small>
            <a href="/" class="nav-link active"><i class="fas fa-chart-pie"></i> Dashboard</a>
            <a href="/?view=calendar#calendarSection" class="nav-link"><i class="fas fa-calendar-alt"></i> Calendário</a>
            <a href="/estatisticas/" class="nav-link"><i class="fas fa-chart-line"></i> Estatísticas</a>
            <small class="text-muted-2 px-4 text-uppercase fw-bold mt-4 d-block" style="font-size:0.7rem;">RPG & Carreira</small>
            <a href="#" class="nav-link rpg-link" data-bs-toggle="tooltip" data-bs-title="Em breve"><i class="fas fa-scroll text-warning"></i> Quests</a>
            <a href="#" class="nav-link rpg-link" data-bs-toggle="tooltip" data-bs-title="Em breve"><i class="fas fa-dragon text-danger"></i> Boss Battles</a>
            <a href="#" class="nav-link rpg-link" data-bs-toggle="tooltip" data-bs-title="Em breve"><i class="fas fa-gem" style="color: var(--accent-pink);"></i> Loja & Skins</a>
            <a href="#" class="nav-link rpg-link" data-bs-toggle="tooltip" data-bs-title="Em breve"><i class="fas fa-users text-info"></i> Guilda</a>
            <small class="text-muted-2 px-4 text-uppercase fw-bold mt-4 d-block" style="font-size:0.7rem;">Configuração</small>
            <a href="/#catalogCollapse" class="nav-link"><i class="fas fa-cog"></i> Ajustes</a>
        </div>
        <div class="p-3 border-top border-secondary border-opacity-25 bg-dark bg-opacity-25">
            <div class="d-flex align-items-center">
                <div class="position-relative me-3">
                    <img src="https://ui-avatars.com/api/?name={{ request.user.username|default:'Dev' }}&background=22e3a1&color=000" class="rounded-circle border border-secondary" width="40" alt="avatar">
                    <span class="position-absolute bottom-0 end-0 bg-success border border-dark rounded-circle p-1"></span>
                </div>
                <div>
                    <div class="fw-bold text-white small">{{ titulo_dev }}</div>
                    <div class="text-warning small"><i class="fas fa-coins"></i> {{ perfil.xp_total|default:0 }} XP</div>
                </div>
            </div>
        </div>
    </nav>

    <nav class="navbar navbar-expand-lg navbar-dark navbar-devtracker navbar-mobile fixed-top py-3 d-lg-none">
        <div class="container">
            <div class="text-end mb-3">
                <a href="/gamer/" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-gamepad me-2"></i>Alternar para Dashboard RPG
                </a>
            </div>
            <a class="navbar-brand d-flex align-items-center" href="{\% url 'core:index' \%}">
                <span class="text-white fw-bold">Dev<span style="color: var(--accent);">Tracker</span></span>
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#mobMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse mt-2" id="mobMenu">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/gamer/quests/">Quests</a></li>
                    <li class="nav-item"><a class="nav-link" href="/gamer/">Guilda</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-content">

    <nav class="navbar navbar-expand-lg navbar-dark navbar-devtracker fixed-top py-3 d-lg-none">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'core:index' %}">
                <svg width="42" height="42" viewBox="0 0 100 100" class="me-2" xmlns="http://www.w3.org/2000/svg">
                    <defs><linearGradient id="bG" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#1abc9c"/><stop offset="100%" style="stop-color:#3498db"/></linearGradient></defs>
                    <path d="M50 5 L95 27.5 L95 72.5 L50 95 L5 72.5 L5 27.5 Z" fill="url(#bG)" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>
                    <text x="50" y="62" font-family="monospace" font-weight="bold" font-size="45" fill="white" text-anchor="middle">&gt;_</text>
                </svg>
                <div class="d-flex flex-column" style="line-height:1;">
                    <span class="text-white fw-bold fs-5">Dev<span style="color: var(--accent);">Tracker</span></span>
                    <span class="text-muted-2" style="font-size:0.65rem; letter-spacing:1px;">GAMIFIED LEARNING</span>
                </div>
            </a>
            <div class="ms-auto d-flex align-items-center gap-2 flex-wrap justify-content-end">
                <a class="btn action-btn btn-sm rounded-pill px-3" href="{% url 'core:estatisticas' %}">
                    <i class="fas fa-chart-line me-1 text-accent"></i> Estatísticas
                </a>
                <a class="btn action-btn btn-sm rounded-pill px-3" href="{% url 'core:conquistas' %}">
                    <i class="fas fa-trophy me-1 text-warning"></i> Conquistas
                </a>

                <div class="chip d-none d-md-flex align-items-center" data-streak="{{ streak }}">
                    <i class="fas fa-fire text-warning me-2"></i> <span class="fw-bold">{{ streak }}</span> <span class="ms-1 text-muted-2">dias</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card hero-card shadow-soft border-0 mb-4 overflow-hidden">
            <div class="card-body p-4 position-relative">
                <div style="position:absolute; top:-40px; right:-40px; width:180px; height:180px; background:rgba(255,255,255,0.05); border-radius:50%;"></div>
                <div class="d-flex flex-column flex-lg-row align-items-lg-center">
                    <div class="d-flex align-items-center flex-grow-1">
                        <div class="avatar-box shadow me-3 text-brand">
                            <i class="fas fa-user-astronaut fa-2x"></i>
                            <span class="badge bg-warning text-dark level-badge border border-white">Nv. {{ perfil.nivel }}</span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <h2 class="fw-bold mb-0">{{ titulo_dev }}</h2>
                                <span class="chip text-muted-2 d-flex align-items-center"><i class="fas fa-bolt text-warning me-2"></i>{{ perfil.xp_total }} XP</span>
                            </div>
                            <div class="d-flex justify-content-between small text-muted-2 mb-1">
                                <span>Próximo nível</span><span>{{ pct_nivel }}%</span>
                            </div>
                            <div class="progress" style="height:10px; background:rgba(255,255,255,0.1);">
                                <div class="progress-bar" style="width:{{ pct_nivel }}%; background: linear-gradient(90deg, var(--accent), var(--accent-2));"></div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-3 mt-3 mt-lg-0">
                        <div class="card-slim px-3 py-2 text-center" style="color: var(--text);">
                            <div class="text-muted-2 small text-uppercase">Horas Totais</div>
                            <div class="fs-5 fw-bold text-white">{{ total_liquido }}</div>
                            {% if diff_semana != 0 %}
                            <small class="{% if diff_semana > 0 %}text-success{% else %}text-danger{% endif %}">
                                <i class="fas fa-arrow-{% if diff_semana > 0 %}up{% else %}down{% endif %} me-1"></i>{{ diff_semana|floatformat:1 }}h vs semana passada
                            </small>
                            {% endif %}
                        </div>
                        <div class="card-slim px-3 py-2 text-center" style="color: var(--text);">
                            <div class="text-muted-2 small text-uppercase">Streak</div>
                            <div class="fs-5 fw-bold text-white"><i class="fas fa-fire text-warning me-1"></i>{{ streak }}d</div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="/tudo/" class="btn filter-pill {% if periodo_atual == 'tudo' %}active{% endif %}">Tudo</a>
                            <a href="/semana/" class="btn filter-pill {% if periodo_atual == 'semana' %}active{% endif %}">Semana</a>
                            <a href="/mes/" class="btn filter-pill {% if periodo_atual == 'mes' %}active{% endif %}">Mês</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer border-0 bg-transparent py-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="d-flex gap-2">
                    {% for c in conquistas_usuario|slice:":5" %}
                        <div class="badge-conquista shadow-sm" style="background:{{ c.cor_hex }}" title="{{ c.nome }}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{{ c.nome }}: {{ c.descricao }}"><i class="{{ c.icone_fa }} fs-6"></i></div>
                    {% empty %}<span class="text-muted-2 small">Nenhuma conquista ainda.</span>{% endfor %}
                </div>
<a href="{% url 'core:conquistas' %}" class="btn btn-sm btn-outline-light rounded-pill px-3 border-0" style="background: rgba(255,255,255,0.08);">Ver Galeria <i class="fas fa-arrow-right ms-1"></i></a>
            </div>
        </div>

        <div class="row mb-4 g-3">
            <div class="col-md-6 col-xl-8">
                <div class="card card-slim border-0 h-100 quest-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold text-white mb-0"><i class="fas fa-scroll text-warning me-2"></i>Missões ativas</h5>
                            <a href="/gamer/quests/" class="btn btn-sm action-btn rounded-pill">Ver quadro</a>
                        </div>
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex align-items-center bg-dark bg-opacity-50 p-2 rounded border border-secondary border-opacity-25">
                                <div class="me-3 text-center" style="width:40px;"><i class="fas fa-dragon text-danger fs-4"></i></div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0 text-white">Boss: API Python</h6>
                                    <small class="text-muted-2">Crie uma API RESTful simples.</small>
                                </div>
                                <div class="text-end"><span class="badge bg-warning text-dark">+500 XP</span></div>
                            </div>
                            <div class="d-flex align-items-center bg-dark bg-opacity-50 p-2 rounded border border-secondary border-opacity-25">
                                <div class="me-3 text-center" style="width:40px;"><i class="fas fa-calendar-check text-info fs-4"></i></div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0 text-white">Daily: Code Review</h6>
                                    <small class="text-muted-2">Ajude 1 colega na guilda.</small>
                                </div>
                                <div class="text-end"><span class="badge bg-info text-dark">+50 Coins</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-4">
                <div class="card card-slim border-0 h-100 party-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold text-white mb-0"><i class="fas fa-users text-accent-pink me-2"></i>Sua Party</h5>
                            <span class="badge bg-dark">Online</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div class="text-center"><img src="https://ui-avatars.com/api/?name=Voce&background=333&color=fff" class="rounded-circle border border-warning" width="40"><div class="small text-muted-2 mt-1">Você</div></div>
                            <div class="text-center"><img src="https://ui-avatars.com/api/?name=Ana&background=bc13fe&color=fff" class="rounded-circle" width="40"><div class="small text-muted-2 mt-1">Ana</div></div>
                            <div class="text-center"><img src="https://ui-avatars.com/api/?name=Bob&background=4db5ff&color=fff" class="rounded-circle" width="40"><div class="small text-muted-2 mt-1">Bob</div></div>
                            <div class="text-center">
                                <div class="rounded-circle border border-secondary d-flex align-items-center justify-content-center text-muted-2" style="width:40px; height:40px;"><i class="fas fa-plus"></i></div>
                                <div class="small text-muted-2 mt-1">Invite</div>
                            </div>
                        </div>
                        <div class="mt-3 text-center"><button class="btn btn-sm btn-dark w-100 rounded-pill">Entrar no chat</button></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card card-slim border-0 shadow-soft mb-4">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 fw-bold text-white"><i class="fas fa-chart-line me-2 text-accent"></i>Resumo Semanal</h6>
                        <small class="text-muted-2">Últimas 8 semanas</small>
                    </div>
                    <a href="{% url 'core:estatisticas' %}" class="btn btn-sm action-btn rounded-pill px-3">
                        <i class="fas fa-chart-bar me-1"></i> Ver Estatísticas
                    </a>
                </div>
                <canvas id="evolucaoChart" style="max-height:180px;" class="mt-3"></canvas>
            </div>
        </div>



        <div class="d-flex justify-content-start align-items-center mb-2 gap-2">
            <div class="btn-group btn-group-sm" role="group" aria-label="Exibição de atividades">
                <button class="btn action-btn" id="btnShowCalendar"><i class="fas fa-calendar-alt me-1"></i>Calendário</button>
                <button class="btn action-btn active" id="btnShowList"><i class="fas fa-list me-1"></i>Lista</button>
            </div>
        </div>

        <div class="card card-slim border-0 shadow-soft mb-4" id="calendarSection" data-sessions='{{ sessions_by_day }}'>
            <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="chip"><i class="fas fa-calendar text-accent"></i></span>
                    <div>
                        <h5 class="mb-0 fw-bold text-white">Calendário de Estudos</h5>
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <button class="btn btn-sm action-btn rounded-pill px-3" type="button" id="navPrev" data-ano="{{ prev_ano }}" data-mes="{{ prev_mes }}"><i class="fas fa-chevron-left"></i></button>
                            <small class="text-muted-2" id="mesLabel">{{ mes_atual }}</small>
                            <button class="btn btn-sm action-btn rounded-pill px-3" type="button" id="navNext" data-ano="{{ next_ano }}" data-mes="{{ next_mes }}"><i class="fas fa-chevron-right"></i></button>
                            <button class="btn btn-sm action-btn rounded-pill px-3" type="button" id="navToday"><i class="fas fa-dot-circle me-1"></i>Hoje</button>
                            <span class="badge bg-light text-dark">Total mês: {{ total_mes }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="calendar-grid">
                    <div class="text-muted-2 text-center fw-bold">Seg</div>
                    <div class="text-muted-2 text-center fw-bold">Ter</div>
                    <div class="text-muted-2 text-center fw-bold">Qua</div>
                    <div class="text-muted-2 text-center fw-bold">Qui</div>
                    <div class="text-muted-2 text-center fw-bold">Sex</div>
                    <div class="text-muted-2 text-center fw-bold">Sáb</div>
                    <div class="text-muted-2 text-center fw-bold">Dom</div>
                    {% for week in calendario %}
                        {% for d in week %}
                            <div class="calendar-cell {% if d.dia and d.segundos > 0 %}active{% endif %} {% if d.data.isoformat == today_iso %}calendar-today{% endif %}" data-day="{{ d.data.isoformat }}" title="{{ d.human }}">
                                {% if d.dia and d.segundos > 0 %}
                                    <div class="calendar-day d-flex justify-content-between align-items-center">
                                        <span>{{ d.dia }}</span>
                                        {% if d.streak %}<span class="badge bg-warning text-dark" style="font-size:0.65rem;"><i class="fas fa-fire"></i> {{ d.streak }}</span>{% endif %}
                                    </div>
                                    <div class="calendar-time">{{ d.human }}</div>
                                {% elif d.dia %}
                                    <div class="calendar-day text-muted-2">{{ d.dia }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% endfor %}
                </div>
                <div class="sessions-panel mt-3" id="daySessions" aria-live="polite"></div>
            </div>
        </div>

        <div class="card card-slim border-0 shadow-soft mb-5" id="listSection">
            <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <span class="chip"><i class="fas fa-history text-accent"></i></span>
                    <div>
                        <h5 class="mb-0 fw-bold text-white">Histórico Recente</h5>
                        <small class="text-muted-2">Últimas 5 sessões</small>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm action-btn rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#fullListModal"><i class="fas fa-list me-2"></i>Ver todas</button>
                    {% if ultima_sessao %}
                    <button class="btn btn-sm action-btn rounded-pill px-3" id="btnRepeatSession" title="Repete tech, método e tópico da última sessão"><i class="fas fa-redo me-2"></i>Repetir</button>
                    {% endif %}
                    <button class="btn btn-sm action-btn rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#regModal"><i class="fas fa-plus me-2"></i>Nova sessão</button>
                </div>
            </div>
            <div class="table-responsive" style="max-height:70vh;">
                <table class="table table-hover align-middle mb-0" id="fullTable">
                    <thead><tr>
                        <th class="ps-3 sortable" data-sort="data" style="color: rgba(255,255,255,0.75);">Data</th>
                        <th class="sortable" data-sort="tech" style="color: rgba(255,255,255,0.75);">Tech</th>
                        <th class="sortable" data-sort="metodo" style="color: rgba(255,255,255,0.75);">Método</th>
                        <th class="sortable" data-sort="tempo" style="color: rgba(255,255,255,0.75);">Tempo</th>
                        <th class="sortable" data-sort="status" style="color: rgba(255,255,255,0.75);">Status</th>
                    </tr></thead>
                    <tbody>
                        {% for s in page_obj %}
                        <tr class="row-view" role="button" tabindex="0"
                            data-tech="{{ s.tecnologia.nome }}" data-metodo="{{ s.metodo.nome }}" data-busca="{{ s.topico }} {{ s.anotacoes }}" data-dia="{{ s.data_registro|date:'Y-m-d' }}"
                            data-sort-data="{{ s.data_registro|date:'Y-m-d H:i' }}" data-sort-tech="{{ s.tecnologia.nome }}" data-sort-metodo="{{ s.metodo.nome }}" data-sort-tempo="{{ s.tempo_liquido.total_seconds }}" data-sort-status="{% if s.qtd_exercicios > 0 %}{{ s.qtd_acertos }}/{{ s.qtd_exercicios }}{% else %}0{% endif %}"
                            data-id="{{ s.id }}" data-tech-id="{{ s.tecnologia.id }}" data-met-id="{{ s.metodo.id }}" data-top="{{ s.topico }}" data-dat="{{ s.data_registro|date:'Y-m-d\TH:i' }}" data-dur="{{ s.tempo_liquido|duration_human }}" data-dur-raw="{{ s.tempo_liquido }}" data-ex="{{ s.qtd_exercicios }}" data-hit="{{ s.qtd_acertos }}" data-tech-name="{{ s.tecnologia.nome }}" data-met-name="{{ s.metodo.nome }}" data-note="{{ s.anotacoes|default_if_none:''|escapejs }}" data-note-html="{{ s.anotacoes|default_if_none:''|markdownify|escapejs }}">
                            <td class="ps-3 fw-bold text-white" data-label="Data">{{ s.data_registro|date:"d/m H:i" }}</td>
                            <td data-label="Tech"><span class="badge rounded-pill px-3 py-2" data-tech="{{ s.tecnologia.nome }}">{{ s.tecnologia.nome }}</span></td>
                            <td data-label="Método"><span class="pill-status method-chip">{{ s.metodo.nome }}</span></td>
                            <td class="fw-bold" data-label="Tempo">{{ s.tempo_liquido|duration_human }}</td>
                            <td data-label="Status">{% if s.qtd_exercicios > 0 %}<span class="badge bg-success bg-opacity-25 text-white border border-success">{{ s.qtd_acertos }}/{{ s.qtd_exercicios }} acertos</span>{% else %}<span class="text-muted-2">-</span>{% endif %}</td>
                        </tr>
                        {% empty %}<tr><td colspan="6" class="text-center py-4 text-muted-2">Nada por aqui.</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card card-slim border-0 shadow-soft mb-5">
            <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0 fw-bold text-white"><i class="fas fa-folder-tree me-2 text-accent"></i>Catálogos de Estudo</h5>
                    <small class="text-muted-2">Gerencie matérias (tecnologias) e métodos.</small>
                </div>
                <button class="btn action-btn btn-sm rounded-pill px-3" type="button" data-bs-toggle="collapse" data-bs-target="#catalogCollapse" aria-expanded="false" aria-controls="catalogCollapse">
                    Expandir/Recolher
                </button>
            </div>
            <div class="collapse" id="catalogCollapse">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card card-slim p-3 h-100">
                                <h6 class="text-muted-2 text-uppercase small">Matérias</h6>
                        <form action="{% url 'core:salvar_tech' %}" method="post" class="d-flex mb-3">{% csrf_token %}<input name="nome" class="form-control me-2" placeholder="Nova Matéria/Tech"><button class="btn btn-success"><i class="fas fa-plus"></i></button></form>
                                <ul class="list-group">
                                    {% for t in techs %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent text-white border-secondary border-opacity-50">{{ t.nome }}<a href="/tech/excluir/{{ t.id }}/" class="text-danger"><i class="fas fa-trash"></i></a></li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card card-slim p-3 h-100">
                                <h6 class="text-muted-2 text-uppercase small">Métodos</h6>
                                <form action="{% url 'core:salvar_metodo' %}" method="post" class="d-flex mb-3">{% csrf_token %}<input name="nome" class="form-control me-2" placeholder="Novo Método"><button class="btn btn-success"><i class="fas fa-plus"></i></button></form>
                                <ul class="list-group">
                                    {% for m in metodos %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent text-white border-secondary border-opacity-50">{{ m.nome }}<a href="/metodo/excluir/{{ m.id }}/" class="text-danger"><i class="fas fa-trash"></i></a></li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal lista completa -->
    <div class="modal fade" id="fullListModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 card-slim">
                <div class="modal-header bg-transparent text-white border-0">
                    <div>
                        <h5 class="modal-title fw-bold"><i class="fas fa-list me-2 text-accent"></i>Todas as atividades</h5>
                        <small class="text-muted-2">Até 200 registros mais recentes. Use os filtros rápidos.</small>
                    </div>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <input class="form-control" id="filterSearch" placeholder="Buscar por tópico/nota...">
                        </div>
                        <div class="col-md-4">
                            <select id="filterTech" class="form-select">
                                <option value="">Tech (todas)</option>
                                {% for t in techs %}<option value="{{ t.nome }}">{{ t.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select id="filterMetodo" class="form-select">
                                <option value="">Método (todos)</option>
                                {% for m in metodos %}<option value="{{ m.nome }}">{{ m.nome }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted-2 small">Data inicial</label>
                            <input class="form-control" id="filterDataIni" type="date">
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted-2 small">Data final</label>
                            <input class="form-control" id="filterDataFim" type="date">
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height:70vh;">
                        <table class="table table-hover align-middle mb-0" id="fullTable">
                            <thead><tr>
                                <th class="ps-3 sortable" data-sort="data" style="color: rgba(255,255,255,0.75);">Data</th>
                                <th class="sortable" data-sort="tech" style="color: rgba(255,255,255,0.75);">Tech</th>
                                <th class="sortable" data-sort="metodo" style="color: rgba(255,255,255,0.75);">Método</th>
                                <th class="sortable" data-sort="tempo" style="color: rgba(255,255,255,0.75);">Tempo</th>
                                <th class="sortable" data-sort="status" style="color: rgba(255,255,255,0.75);">Status</th>
                            </tr></thead>
                            <tbody>
                                {% for s in page_obj %}
                                <tr class="row-view" role="button" tabindex="0"
                                    data-tech="{{ s.tecnologia.nome }}" data-metodo="{{ s.metodo.nome }}" data-busca="{{ s.topico }} {{ s.anotacoes }}" data-dia="{{ s.data_registro|date:'Y-m-d' }}"
                                    data-sort-data="{{ s.data_registro|date:'Y-m-d H:i' }}" data-sort-tech="{{ s.tecnologia.nome }}" data-sort-metodo="{{ s.metodo.nome }}" data-sort-tempo="{{ s.tempo_liquido.total_seconds }}" data-sort-status="{% if s.qtd_exercicios > 0 %}{{ s.qtd_acertos }}/{{ s.qtd_exercicios }}{% else %}0{% endif %}"
                                    data-id="{{ s.id }}" data-tech-id="{{ s.tecnologia.id }}" data-met-id="{{ s.metodo.id }}" data-top="{{ s.topico }}" data-dat="{{ s.data_registro|date:'Y-m-d\TH:i' }}" data-dur="{{ s.tempo_liquido|duration_human }}" data-dur-raw="{{ s.tempo_liquido }}" data-ex="{{ s.qtd_exercicios }}" data-hit="{{ s.qtd_acertos }}" data-tech-name="{{ s.tecnologia.nome }}" data-met-name="{{ s.metodo.nome }}" data-note="{{ s.anotacoes|default_if_none:''|escapejs }}" data-note-html="{{ s.anotacoes|default_if_none:''|markdownify|escapejs }}">
                                    <td class="ps-3 fw-bold text-white" data-label="Data">{{ s.data_registro|date:"d/m H:i" }}</td>
                                    <td data-label="Tech"><span class="badge rounded-pill px-3 py-2" data-tech="{{ s.tecnologia.nome }}">{{ s.tecnologia.nome }}</span></td>
                                    <td data-label="Método"><span class="pill-status method-chip">{{ s.metodo.nome }}</span></td>
                                    <td class="fw-bold" data-label="Tempo">{{ s.tempo_liquido|duration_human }}</td>
                                    <td data-label="Status">{% if s.qtd_exercicios > 0 %}<span class="badge bg-success bg-opacity-25 text-white border border-success">{{ s.qtd_acertos }}/{{ s.qtd_exercicios }} acertos</span>{% else %}<span class="text-muted-2">-</span>{% endif %}</td>
                                </tr>
                                {% empty %}<tr><td colspan="5" class="text-center py-4 text-muted-2">Nada por aqui.</td></tr>{% endfor %}
                            </tbody>
                        </table>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="text-muted-2 small">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</div>
                            <div class="btn-group">
                                {% if page_obj.has_previous %}
                                    <a class="btn btn-sm action-btn" href="?page={{ page_obj.previous_page_number }}{% if periodo_atual %}&periodo={{ periodo_atual }}{% endif %}{% if mostrar_todas %}&full=1{% endif %}#fullListModal">Anterior</a>
                                {% endif %}
                                {% if page_obj.has_next %}
                                    <a class="btn btn-sm action-btn" href="?page={{ page_obj.next_page_number }}{% if periodo_atual %}&periodo={{ periodo_atual }}{% endif %}{% if mostrar_todas %}&full=1{% endif %}#fullListModal">Próxima</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 d-flex justify-content-between">
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm action-btn rounded-pill px-3" id="btnExportCsv"><i class="fas fa-file-csv me-1"></i>CSV</button>
                        <button class="btn btn-sm action-btn rounded-pill px-3" id="btnExportJson"><i class="fas fa-file-code me-1"></i>JSON</button>
                    </div>
                    <button class="btn btn-outline-light" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    </div> <!-- main-content -->

    <button class="floating-button" data-bs-toggle="modal" data-bs-target="#regModal"><i class="fas fa-plus me-2"></i>Nova Sessão</button>

    <div class="modal fade" id="regModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content border-0 card-slim"><div class="modal-header bg-transparent text-white border-0"><h5 class="modal-title fw-bold"><i class="fas fa-rocket me-2 text-accent"></i>Nova Sessão</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form method="post" action="">{% csrf_token %}<div class="modal-body p-4">
        <div class="d-flex align-items-center justify-content-between bg-dark bg-opacity-25 border border-secondary border-opacity-50 rounded-3 p-3 mb-3">
            <div>
                <div class="text-muted-2 small">Cronômetro</div>
                <div class="h4 mb-0 fw-bold" id="chronoDisplay">00:00:00</div>
            </div>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-success btn-sm" id="chronoStart"><i class="fas fa-play"></i></button>
                <button type="button" class="btn btn-warning btn-sm" id="chronoPause"><i class="fas fa-pause"></i></button>
                <button type="button" class="btn btn-secondary btn-sm" id="chronoReset"><i class="fas fa-undo"></i></button>
            </div>
        </div>
        <div class="row">{% for f in form %}<div class="col-md-6 mb-3">
            <label class="small fw-bold text-muted-2">{{ f.label }}</label>
            {% if f.name == 'anotacoes' %}
                {{ f|add_class:"form-control shadow-sm"|attr:"data-bs-toggle:tooltip"|attr:"data-bs-title:Use Markdown: **negrito**, `inline code`, ```blocos```"|attr:"id:id_anotacoes" }}
                <small class="text-muted-2">Preview:</small>
                <div class="card-slim p-2" id="previewNovo"></div>
            {% else %}
                {{ f|add_class:"form-control shadow-sm" }}
            {% endif %}
        </div>{% endfor %}</div></div><div class="modal-footer border-0"><button class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-success fw-bold px-4">Salvar</button></div></form></div></div></div>
    
    <div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content border-0 card-slim"><div class="modal-header bg-transparent text-white border-0"><h5 class="modal-title fw-bold">Editar sessão</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><form method="post" id="formEdit">{% csrf_token %}<div class="modal-body p-4"><div class="row"><div class="col-12 mb-2"><label class="small fw-bold text-muted-2">Tech</label><select name="tecnologia" id="e_tech" class="form-select">{% for t in techs %}<option value="{{ t.id }}">{{ t.nome }}</option>{% endfor %}</select></div><div class="col-12 mb-2"><label class="small fw-bold text-muted-2">Tópico</label><input name="topico" id="e_top" class="form-control" placeholder="Ex.: Revisar views"></div><div class="col-12 mb-2"><label class="small fw-bold text-muted-2">Método</label><select name="metodo" id="e_met" class="form-select">{% for m in metodos %}<option value="{{ m.id }}">{{ m.nome }}</option>{% endfor %}</select></div><div class="col-6"><label class="small fw-bold text-muted-2">Data</label><input name="data_registro" id="e_dat" type="datetime-local" class="form-control"></div><div class="col-6"><label class="small fw-bold text-muted-2">Tempo</label><input name="tempo_liquido" id="e_dur" class="form-control" placeholder="01:30:00"></div><div class="col-6"><label class="small fw-bold text-muted-2">Exercícios</label><input name="qtd_exercicios" id="e_ex" type="number" class="form-control" placeholder="10"></div><div class="col-6"><label class="small fw-bold text-muted-2">Acertos</label><input name="qtd_acertos" id="e_hit" type="number" class="form-control" placeholder="8"></div><div class="col-12"><label class="small fw-bold text-muted-2">Notas (Markdown)</label><textarea name="anotacoes" id="e_note" class="form-control" rows="3" placeholder="Resumo, links, onde parar..." data-bs-toggle="tooltip" data-bs-title="Use Markdown: **negrito**, `inline code`, ```blocos```"></textarea><small class="text-muted-2">Preview:</small><div class="card-slim p-2" id="previewEdit"></div></div></div></div><div class="modal-footer border-0"><button type="submit" class="btn btn-success">Salvar</button></div></form></div></div></div>

    <div class="modal fade" id="detailModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content border-0 card-slim"><div class="modal-header bg-transparent text-white border-0"><h5 class="modal-title fw-bold">Detalhes da sessão</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-4">
        <div class="row g-3 mb-3">
            <div class="col-md-4"><div class="chip d-flex flex-column align-items-start"><small class="text-white opacity-75">Tech</small><span id="dTech" class="fw-bold"></span></div></div>
            <div class="col-md-4"><div class="chip d-flex flex-column align-items-start"><small class="text-white opacity-75">Método</small><span id="dMet" class="fw-bold"></span></div></div>
            <div class="col-md-4"><div class="chip d-flex flex-column align-items-start"><small class="text-white opacity-75">Tempo</small><span id="dDur" class="fw-bold"></span></div></div>
            <div class="col-md-4"><div class="chip d-flex flex-column align-items-start"><small class="text-white opacity-75">Data</small><span id="dDat" class="fw-bold"></span></div></div>
            <div class="col-md-4"><div class="chip d-flex flex-column align-items-start"><small class="text-white opacity-75">Exercícios</small><span id="dEx" class="fw-bold"></span></div></div>
            <div class="col-md-4"><div class="chip d-flex flex-column align-items-start"><small class="text-white opacity-75">Acertos</small><span id="dHit" class="fw-bold"></span></div></div>
        </div>
        <div class="card-slim p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-white">Notas (Markdown)</h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm action-btn rounded-pill px-3" id="btnEditFromDetail"><i class="fas fa-pen me-1"></i>Editar</button>
                    <button class="btn btn-sm btn-danger rounded-pill px-3" id="btnDeleteFromDetail"><i class="fas fa-trash me-1"></i>Excluir</button>
                </div>
            </div>
            <div id="dNote" class="text-muted-2"></div>
        </div>
    </div></div></div>

    <div class="modal fade" id="delModal"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 card-slim"><div class="modal-body text-center p-4"><h4 class="mb-3">Tem certeza?</h4><form method="post" id="formExcluir">{% csrf_token %}<button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Não</button><button type="submit" class="btn btn-danger px-4">Sim, apagar</button></form></div></div></div></div>

    {% if novas_conquistas %}
    <div class="modal fade show" style="display:block; background:rgba(0,0,0,0.85);" onclick="this.remove();">
        <div class="modal-dialog modal-dialog-centered" onclick="event.stopPropagation();">
            <div class="modal-content bg-transparent border-0 text-center position-relative overflow-hidden">
                <div id="confetti"></div>
                <i class="fas fa-trophy text-warning fa-4x mb-3 fa-beat"></i>
                <h2 class="text-white fw-bold mb-4">Conquista desbloqueada!</h2>
                {% for n in novas_conquistas %}
                    <div class="card-slim bg-white bg-opacity-10 border-0 text-white rounded p-3 mb-3 mx-auto" style="max-width:320px; animation: pop 0.5s ease;">
                        <div class="badge-conquista mx-auto mb-2" style="background:{{ n.cor_hex }}"><i class="{{ n.icone_fa }}"></i></div>
                        <h5 class="fw-bold">{{ n.nome }}</h5>
                        <span class="badge bg-warning text-dark">+{{ n.xp_reward }} XP</span>
                    </div>
                {% endfor %}
                <div class="d-flex justify-content-center gap-2">
                    <a class="btn btn-warning fw-bold rounded-pill px-4" href="{% url 'core:conquistas' %}">Ver conquistas</a>
                    <button class="btn btn-light fw-bold rounded-pill px-4" onclick="this.closest('.modal').remove();">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="toast-container">
        <div class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true" id="sessionToast">
            <div class="d-flex">
                <div class="toast-body"><i class="fas fa-check-circle text-success me-2"></i> Sessão registrada com sucesso.</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% load static %}
    <script src="{% static 'core/improvements.js' %}"></script>
    <script src="{% static 'core/features.js' %}"></script>
    <script src="{% static 'core/quick-actions.js' %}"></script>
    <script>
        // Cores e Ícones - ampliado
        const mapC = {'Python':'#3776ab','Django':'#092e20','JavaScript':'#f7df1e','HTML/CSS':'#e34c26','SQL':'#4479A1','Git':'#f05032','GitHub':'#181717','PostgreSQL':'#336791','React':'#61dafb','PHP':'#777bb4','Laravel':'#ff2d20','Kotlin':'#7f52ff','MySQL':'#4479A1','Rust':'#dea584','Docker':'#2496ed','Ruby':'#cc342d','Swift':'#fa7343','TypeScript':'#3178c6','C#':'#178600','C++':'#00599c','C':'#3a4049','Lógica de Programação':'#7f8c8d'};
        const mapI = {'Python':'fab fa-python','Django':'fas fa-leaf','JavaScript':'fab fa-js-square','HTML/CSS':'fab fa-html5','SQL':'fas fa-database','Git':'fab fa-git-alt','GitHub':'fab fa-github','PostgreSQL':'fas fa-database','React':'fab fa-react','PHP':'fab fa-php','Laravel':'fab fa-laravel','Kotlin':'fas fa-robot','MySQL':'fas fa-database','Rust':'fab fa-rust','Docker':'fab fa-docker','Ruby':'fas fa-gem','Swift':'fab fa-swift','TypeScript':'fab fa-js','C#':'fas fa-hashtag','C++':'fab fa-cuttlefish','C':'fas fa-microchip','Lógica de Programação':'fas fa-brain'};
        const defaultIcon='fas fa-code', defaultColor='#7f8c8d';
        document.querySelectorAll('.badge[data-tech]').forEach(b=>{
            const n=b.getAttribute('data-tech');
            b.style.backgroundColor = mapC[n] || defaultColor;
            if(['JavaScript','React','TypeScript'].includes(n)) b.style.color='#333'; else b.style.color='white';
            const iconClass = mapI[n] || defaultIcon;
            const i=document.createElement('i'); i.className=iconClass+' me-1'; b.prepend(i);
        });

        // Charts
        Chart.defaults.font.family="'Space Grotesk','Segoe UI',sans-serif";
        const tD=JSON.parse('{{ tech_json|safe }}'), tL=tD.map(i=>i.nome), tV=tD.map(i=>i.sec/3600);
        const mD=JSON.parse('{{ metodo_json|safe }}'), mL=mD.map(i=>i.nome), mV=mD.map(i=>i.sec/3600);
        const eD=JSON.parse('{{ evolucao_json|safe }}'), eL=eD.map(i=>i.semana), eV=eD.map(i=>i.horas);
        try{
            new Chart(document.getElementById('evolucaoChart'),{type:'line',data:{labels:eL,datasets:[{label:'Horas',data:eV,borderColor:'#22e3a1',backgroundColor:'rgba(34,227,161,0.1)',tension:0.4,fill:true,pointRadius:3,pointHoverRadius:5}]},options:{responsive:true,maintainAspectRatio:true,scales:{x:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#cdd7e3',font:{size:10}}},y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#cdd7e3',font:{size:10},callback:v=>v+'h'}}},plugins:{legend:{display:false},tooltip:{backgroundColor:'rgba(15,22,36,0.9)',titleColor:'#fff',bodyColor:'#cdd7e3',borderColor:'#22e3a1',borderWidth:1}}}});
        }catch(e){ console.warn('Chart init error', e); }

        function renderMarkdown(value){
            if(typeof marked === 'undefined' || typeof DOMPurify === 'undefined') return value || '';
            marked.setOptions({breaks:true});
            return DOMPurify.sanitize(marked.parse(value || ''));
        }
        function enhanceCodeBlocks(container){
            if(!container) return;
            container.querySelectorAll('pre').forEach(pre=>{
                if(pre.querySelector('.copy-btn')) return;
                const btn=document.createElement('button');
                btn.type='button';
                btn.className='btn btn-sm btn-secondary copy-btn';
                btn.textContent='Copiar';
                btn.style.float='right';
                btn.style.marginTop='-6px';
                btn.onclick=()=>navigator.clipboard?.writeText(pre.innerText.trim());
                pre.prepend(btn);
            });
        }
        function bindPreview(inputId, previewId){
            const input=document.getElementById(inputId);
            const preview=document.getElementById(previewId);
            if(!input || !preview) return;
            const render=()=>{
                const html = renderMarkdown(input.value);
                preview.innerHTML = html || '<span class="text-muted-2">Sem notas.</span>';
                enhanceCodeBlocks(preview);
            };
            input.addEventListener('input', render);
            render();
        }

        function fillEditForm(data){
            document.getElementById('e_tech').value=data.techId;
            document.getElementById('e_top').value=data.topico;
            document.getElementById('e_met').value=data.metodoId;
            document.getElementById('e_dat').value=data.data;
            document.getElementById('e_dur').value=data.durRaw;
            document.getElementById('e_ex').value=data.ex || 0;
            document.getElementById('e_hit').value=data.hit || 0;
            const noteDecoded = data.noteRaw ? JSON.parse(`"${data.noteRaw}"`) : '';
            document.getElementById('e_note').value=noteDecoded;
            document.getElementById('formEdit').action='/editar/'+data.id+'/';
            bindPreview('e_note','previewEdit');
        }

        function showDetail(data){
            document.getElementById('dTech').textContent = data.techName || '';
            document.getElementById('dMet').textContent = data.metName || '';
            document.getElementById('dDur').textContent = data.durHuman || '';
            document.getElementById('dDat').textContent = (data.data || '').replace('T',' ');
            document.getElementById('dEx').textContent = data.ex || '0';
            document.getElementById('dHit').textContent = data.hit || '0';
            const noteDiv = document.getElementById('dNote');
            let noteHtmlSafe = '';
            try { noteHtmlSafe = data.noteHtml ? JSON.parse(`"${data.noteHtml}"`) : ''; } catch(e){ noteHtmlSafe = data.noteHtml || ''; }
            noteDiv.innerHTML = noteHtmlSafe || '<span class="text-muted-2">Sem notas.</span>';
            
            const btnEdit = document.getElementById('btnEditFromDetail');
            btnEdit.onclick = ()=>{
                fillEditForm(data);
                const detailModalEl = document.getElementById('detailModal');
                const modalDetail = bootstrap.Modal.getInstance(detailModalEl);
                if(modalDetail){
                    detailModalEl.addEventListener('hidden.bs.modal', function openEditModal() {
                        detailModalEl.removeEventListener('hidden.bs.modal', openEditModal);
                        const modalEdit = new bootstrap.Modal(document.getElementById('editModal'));
                        modalEdit.show();
                    });
                    modalDetail.hide();
                }
            };
            
            if(window.DevTracker) window.DevTracker.setupDeleteButton(data.id);
            
            const modalDetail = new bootstrap.Modal(document.getElementById('detailModal'));
            modalDetail.show();
        }

        function extractData(el){
            const g = (attr)=> el.getAttribute(attr) || '';
            return {
                id: g('data-id'),
                techId: g('data-tech') || g('data-tech-id'),
                topico: g('data-top'),
                metodoId: g('data-met') || g('data-met-id'),
                data: g('data-dat'),
                durRaw: g('data-dur-raw'),
                durHuman: g('data-dur'),
                ex: g('data-ex'),
                hit: g('data-hit'),
                noteRaw: g('data-note'),
                noteHtml: g('data-note-html'),
                techName: g('data-tech-name') || g('data-tech'),
                metName: g('data-met-name') || g('data-metodo'),
            };
        }

        document.querySelectorAll('.btn-view').forEach(b=>{
            b.addEventListener('click',()=>{
                showDetail(extractData(b));
            });
        });

        // Clique nas linhas da tabela do modal
        document.addEventListener('click', (e) => {
            const row = e.target.closest('#fullListModal tr.row-view');
            if (!row) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const detailData = extractData(row);
            const fullListModalEl = document.getElementById('fullListModal');
            const fullListModal = bootstrap.Modal.getInstance(fullListModalEl);
            
            if (fullListModal) {
                fullListModalEl.addEventListener('hidden.bs.modal', function openDetailModal() {
                    fullListModalEl.removeEventListener('hidden.bs.modal', openDetailModal);
                    
                    document.getElementById('dTech').textContent = detailData.techName || '';
                    document.getElementById('dMet').textContent = detailData.metName || '';
                    document.getElementById('dDur').textContent = detailData.durHuman || '';
                    document.getElementById('dDat').textContent = (detailData.data || '').replace('T',' ');
                    document.getElementById('dEx').textContent = detailData.ex || '0';
                    document.getElementById('dHit').textContent = detailData.hit || '0';
                    
                    const noteDiv = document.getElementById('dNote');
                    let noteHtmlSafe = '';
                    try { noteHtmlSafe = detailData.noteHtml ? JSON.parse(`"${detailData.noteHtml}"`) : ''; } catch(e){ noteHtmlSafe = detailData.noteHtml || ''; }
                    noteDiv.innerHTML = noteHtmlSafe || '<span class="text-muted-2">Sem notas.</span>';
                    
                    const btnEdit = document.getElementById('btnEditFromDetail');
                    btnEdit.onclick = ()=>{
                        fillEditForm(detailData);
                        const detailModalEl = document.getElementById('detailModal');
                        const modalDetail = bootstrap.Modal.getInstance(detailModalEl);
                        if(modalDetail){
                            detailModalEl.addEventListener('hidden.bs.modal', function openEditModal() {
                                detailModalEl.removeEventListener('hidden.bs.modal', openEditModal);
                                const modalEdit = new bootstrap.Modal(document.getElementById('editModal'));
                                modalEdit.show();
                            });
                            modalDetail.hide();
                        }
                    };
                    
                    if(window.DevTracker) window.DevTracker.setupDeleteButton(detailData.id);
                    
                    const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
                    detailModal.show();
                });
                
                fullListModal.hide();
            }
        });

        // Toast feedback
        const sessionSaved = {{ session_saved|yesno:"true,false" }};
        if(sessionSaved){
            const toastEl = document.getElementById('sessionToast');
            try { const toast = new bootstrap.Toast(toastEl); toast.show(); } catch(e){}
        }
        // Toggle calendário/lista com persistência
        let calendarSection = document.getElementById('calendarSection');
        const listSectionEl = document.getElementById('listSection');
        const btnCal = document.getElementById('btnShowCalendar');
        const btnList = document.getElementById('btnShowList');
        const setView = (view)=>{
            const next = view === 'calendar' ? 'calendar' : 'list';
            localStorage.setItem('dt_view', next);
            if(next === 'calendar'){
                if(calendarSection) calendarSection.style.display='block';
                if(listSectionEl) listSectionEl.style.display='none';
                if(btnCal) btnCal.classList.add('active');
                if(btnList) btnList.classList.remove('active');
                location.hash = 'calendarSection';
            } else {
                if(calendarSection) calendarSection.style.display='none';
                if(listSectionEl) listSectionEl.style.display='block';
                if(btnList) btnList.classList.add('active');
                if(btnCal) btnCal.classList.remove('active');
            }
        };
        const urlView = new URLSearchParams(window.location.search).get('view');
        const initialView = urlView || localStorage.getItem('dt_view') || 'list';
        setView(initialView);
        if(btnCal) btnCal.addEventListener('click',()=>setView('calendar'));
        if(btnList) btnList.addEventListener('click',()=>setView('list'));

        // Cronômetro
        let chronoInterval=null, chronoSeconds=0;
        const chronoDisplay=document.getElementById('chronoDisplay');
        const inputTempo=document.getElementById('id_tempo_liquido');
        const startBtn=document.getElementById('chronoStart');
        const pauseBtn=document.getElementById('chronoPause');
        const resetBtn=document.getElementById('chronoReset');
        function pad(n){return String(n).padStart(2,'0');}
        function updateChrono(){
            const h=Math.floor(chronoSeconds/3600);
            const m=Math.floor((chronoSeconds%3600)/60);
            const s=chronoSeconds%60;
            const str=`${pad(h)}:${pad(m)}:${pad(s)}`;
            if(chronoDisplay) chronoDisplay.textContent=str;
            if(inputTempo){ inputTempo.value=str; }
        }
        if(startBtn && pauseBtn && resetBtn){
            startBtn.addEventListener('click',()=>{
                if(chronoInterval) return;
                chronoInterval=setInterval(()=>{ chronoSeconds+=1; updateChrono(); },1000);
            });
            pauseBtn.addEventListener('click',()=>{
                if(chronoInterval){ clearInterval(chronoInterval); chronoInterval=null; }
            });
            resetBtn.addEventListener('click',()=>{
                chronoSeconds=0; updateChrono();
                if(chronoInterval){ clearInterval(chronoInterval); chronoInterval=null; }
            });
            updateChrono();
        }

        // ESC fecha modais
        document.addEventListener('keydown',(e)=>{
            if(e.key === 'Escape'){
                document.querySelectorAll('.modal.show').forEach(m=>{
                    const inst = bootstrap.Modal.getInstance(m);
                    if(inst) inst.hide();
                });
            }
        });

        // Clique nas linhas da tabela principal
        document.addEventListener('click', (e) => {
            const row = e.target.closest('#listSection tr.row-view');
            if (!row) return;
            
            e.preventDefault();
            const detailData = extractData(row);
            showDetail(detailData);
        });

        // Navegação de calendário via fetch parcial
        const navPrev = document.getElementById('navPrev');
        const navNext = document.getElementById('navNext');
        const navToday = document.getElementById('navToday');
        function loadCalendar(url){
            fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}})
                .then(r=>r.text())
                .then(html=>{
                    const tmp = document.createElement('div');
                    tmp.innerHTML = html;
                    const newCal = tmp.querySelector('#calendarSection');
                    if(newCal && calendarSection){
                        calendarSection.replaceWith(newCal);
                        calendarSection = newCal;
                        loadDataMap();
                        // rebind tooltips
                        [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(el=>{new bootstrap.Tooltip(el);});
                        // rebind nav buttons and day click
                        bindCalendarNav(newCal);
                        bindCalendarDays(newCal);
                        setView('calendar');
                        location.hash = 'calendarSection';
                    }
                })
                .catch(e=>console.error(e));
        }
        function bindCalendarNav(scope){
            const prev = scope.querySelector('#navPrev');
            const next = scope.querySelector('#navNext');
            const todayBtn = scope.querySelector('#navToday');
            if(prev){
                prev.onclick = ()=>{
                    const url = new URL(window.location.href);
                    const m = prev.getAttribute('data-mes');
                    const a = prev.getAttribute('data-ano');
                    url.searchParams.set('mes', m);
                    url.searchParams.set('ano', a);
                    url.searchParams.set('view','calendar');
                    loadCalendar(url.toString());
                };
            }
            if(next){
                next.onclick = ()=>{
                    const url = new URL(window.location.href);
                    const m = next.getAttribute('data-mes');
                    const a = next.getAttribute('data-ano');
                    url.searchParams.set('mes', m);
                    url.searchParams.set('ano', a);
                    url.searchParams.set('view','calendar');
                    loadCalendar(url.toString());
                };
            }
            if(todayBtn){
                todayBtn.onclick = ()=>{
                    const url = new URL(window.location.href);
                    const today = '{{ today_iso }}'.split('-');
                    url.searchParams.set('mes', today[1]);
                    url.searchParams.set('ano', today[0]);
                    url.searchParams.set('view','calendar');
                    loadCalendar(url.toString());
                };
            }
        }
        if(calendarSection){ bindCalendarNav(calendarSection); }

        // Filtros do modal "Ver todas"
        const searchInput = document.getElementById('filterSearch');
        const techSelect = document.getElementById('filterTech');
        const metodoSelect = document.getElementById('filterMetodo');
        const dataIni = document.getElementById('filterDataIni');
        const dataFim = document.getElementById('filterDataFim');
        const fullTable = document.getElementById('fullTable');
        function filtrarFull(){
            const termo = (searchInput?.value || '').toLowerCase();
            const tech = (techSelect?.value || '').toLowerCase();
            const met = (metodoSelect?.value || '').toLowerCase();
            const dIni = dataIni?.value;
            const dFim = dataFim?.value;
            if(!fullTable) return;
            fullTable.querySelectorAll('tbody tr').forEach(tr=>{
                const txt = (tr.getAttribute('data-busca') || '').toLowerCase();
                const t = (tr.getAttribute('data-tech') || '').toLowerCase();
                const m = (tr.getAttribute('data-metodo') || '').toLowerCase();
                const dia = tr.getAttribute('data-dia');
                let dentroData = true;
                if(dIni && dia < dIni) dentroData = false;
                if(dFim && dia > dFim) dentroData = false;
                const match = (!termo || txt.includes(termo)) && (!tech || t === tech) && (!met || m === met) && dentroData;
                tr.style.display = match ? '' : 'none';
            });
        }
        [searchInput, techSelect, metodoSelect, dataIni, dataFim].forEach(el=>{
            if(el) el.addEventListener('input', filtrarFull);
            if(el) el.addEventListener('change', filtrarFull);
        });

        // Ordenação simples
        function sortTable(tableId, selectorHeads){
            const table = document.getElementById(tableId);
            if(!table) return;
            table.querySelectorAll(selectorHeads).forEach(th=>{
                th.addEventListener('click',()=>{
                    const key = th.getAttribute('data-sort');
                    const rows = Array.from(table.querySelectorAll('tbody tr')).filter(r=>r.getAttribute(`data-sort-${key}`)!==null);
                    const asc = !th.classList.contains('sorted-asc');
                    table.querySelectorAll(selectorHeads).forEach(h=>h.classList.remove('sorted-asc','sorted-desc'));
                    th.classList.add(asc?'sorted-asc':'sorted-desc');
                    rows.sort((a,b)=>{
                        const va=a.getAttribute(`data-sort-${key}`), vb=b.getAttribute(`data-sort-${key}`);
                        if(key==='data'||key==='tempo'||key==='status'||key==='ex'||key==='acertos'){
                            return asc ? (va - vb) : (vb - va);
                        }
                        return asc ? va.localeCompare(vb) : vb.localeCompare(va);
                    });
                    const tbody = table.querySelector('tbody');
                    rows.forEach(r=>tbody.appendChild(r));
                });
            });
        }
        sortTable('recentTable', 'thead .sortable');
        sortTable('fullTable', 'thead .sortable');

        // Sessions by day
        let dataMap = {};
        const loadDataMap = ()=>{
            const container = document.getElementById('calendarSection');
            if(container && container.dataset.sessions){
                try { dataMap = JSON.parse(container.dataset.sessions); }
                catch(e){ dataMap = {}; }
            }
        };
        loadDataMap();
        function bindCalendarDays(scope){
            const panel=document.getElementById('daySessions');
            if(!scope) return;
            scope.querySelectorAll('.calendar-cell[data-day]').forEach(cell=>{
                cell.addEventListener('click',()=>{
                    scope.querySelectorAll('.calendar-cell').forEach(c=>c.classList.remove('calendar-selected'));
                    cell.classList.add('calendar-selected');
                    const day=cell.getAttribute('data-day');
                    const list=dataMap[day] || [];
                    let html='<div class="fw-bold mb-2">'+(day||'')+'</div>';
                    if(list.length===0){ html+='<span class="text-muted-2">Sem sessões.</span>'; }
                    else{
                        list.forEach(s=>{
                            html+=`<div class="d-flex justify-content-between border-bottom border-opacity-25 py-1">
                                <div><span class="badge method-chip me-2">${s.metodo}</span><strong>${s.tech}</strong> - ${s.topico}</div>
                                <div class="text-muted-2">${s.hora} • ${s.tempo}</div>
                            </div>`;
                        });
                    }
                    if(panel){ panel.innerHTML=html; }
                });
            });
        }
        bindCalendarDays(calendarSection || document);

        // Export CSV/JSON
        function exportFull(format){
            const rows = Array.from(document.querySelectorAll('#fullTable tbody tr')).filter(r=>r.style.display!=='none');
            const data = rows.map(r=>({
                data: r.children[0].innerText.trim(),
                tech: r.children[1].innerText.trim(),
                metodo: r.children[2].innerText.trim(),
                tempo: r.children[3].innerText.trim(),
                status: r.children[4].innerText.trim(),
                exercicios: r.children[5]?.innerText.trim(),
                acertos: r.children[6]?.innerText.trim(),
            }));
            if(format==='json'){
                const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
                const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='atividades.json'; a.click(); URL.revokeObjectURL(url);
            } else {
                const header='Data,Tech,Método,Tempo,Status,Exercícios,Acertos\n';
                const body=data.map(d=>[d.data,d.tech,d.metodo,d.tempo,d.status,d.exercicios,d.acertos].map(v=>`"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
                const blob=new Blob([header+body],{type:'text/csv'});
                const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='atividades.csv'; a.click(); URL.revokeObjectURL(url);
            }
        }
        const btnCsv=document.getElementById('btnExportCsv');
        const btnJson=document.getElementById('btnExportJson');
        if(btnCsv) btnCsv.addEventListener('click',()=>exportFull('csv'));
        if(btnJson) btnJson.addEventListener('click',()=>exportFull('json'));

        bindPreview('id_anotacoes','previewNovo');
        bindPreview('e_note','previewEdit');

        // Confete simples para conquistas
        (function confetti(){
            const container = document.getElementById('confetti');
            if(!container) return;
            for(let i=0;i<40;i++){
                const p=document.createElement('div');
                p.textContent = ['🎉','✨','🪙','⭐'][i%4];
                p.style.position='absolute';
                p.style.left=Math.random()*100+'%';
                p.style.top='-10%';
                p.style.fontSize=(Math.random()*14+12)+'px';
                p.style.animation=`confettiFall ${Math.random()*2+2}s linear forwards`;
                p.style.animationDelay=(Math.random()*0.8)+'s';
                container.appendChild(p);
            }
        })();
        // tooltips
        [...document.querySelectorAll('[data-bs-toggle=\"tooltip\"]')].forEach(el=>{
            new bootstrap.Tooltip(el);
        });
    </script>
</body>
</html>
